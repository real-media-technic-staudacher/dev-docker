version: '3.9'
services:
  proxy:
    image: traefik:v2.9
    restart: always
    container_name: proxy
    depends_on:
      - step-ca
    networks:
      default:
    ports:
      - "80:80"
      - "443:443"
    environment:
      TRAEFIK_CERTIFICATESRESOLVERS_DEFAULT: true
      TRAEFIK_CERTIFICATESRESOLVERS_DEFAULT_ACME_CASERVER: https://step-ca/acme/ACME/directory
      TRAEFIK_CERTIFICATESRESOLVERS_DEFAULT_ACME_EMAIL: id.dev@staudacher.de
      TRAEFIK_CERTIFICATESRESOLVERS_DEFAULT_ACME_TLSCHALLENGE: true
      LEGO_CA_CERTIFICATES: /certificates/certs/root_ca.crt
      LEGO_CA_SERVER_NAME: step-ca
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - step-ca:/certificates
  step-ca:
    image: smallstep/step-ca
    container_name: step-ca
    networks:
      default:
    ports:
      - 9850:9000
    volumes:
      - step-ca:/home/step
    environment:
      - DOCKER_STEPCA_INIT_NAME=staudacher-dev-ca
      - DOCKER_STEPCA_INIT_PASSWORD=staudacher
      - DOCKER_STEPCA_INIT_DNS_NAMES=0.0.0.0
      - DOCKER_STEPCA_INIT_REMOTE_MANAGEMENT=true
      - DOCKER_STEPCA_INIT_ACME=true

volumes:
  step-ca:
    external: false

networks:
  default:
    name: webproxy